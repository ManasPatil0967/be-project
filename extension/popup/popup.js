// Constants
const VM1_BASE_URL = 'http://34.173.183.183:5000';
const VM2_BASE_URL = 'http://34.55.135.135:3000';

const sample = {
    "privateIdentity": {
        "kyberPrivateKey": "02cf45e205a5e2a8c94f339d54d55c99619b881fcf5dd0f7ade28f7ba71fe2efc91158fcfc96ba18a78b34c807a734abc77dc8803df4a4bf3c344695f16c65cc5c1c155218455c31fb218dc50004d15312545bd523ad9b66bebf043cea2b29bf82aec4a83a38a220b124a59fea68d51915795184c98cc13f3439d753024ff5719b307f42f417dc800e9a365689f1304814a3a438a712ab98bf089205fb4daf4a59efe137fc8780def3791e99508c58781d65a2bada40456931c423c509732f59f70ee75c38747182b80251bdfc71634699c8c25825a9b8fe046ef4c088744490b6028043c1bf82356a0a5c7f0433bcf023ce41c5c008020ea02629a19741d39a6db47bccd87caee0559794dc82b6b68c03153dfc3c78530744ec85b0ced9af91390e7feca8b7ab2e2f70475d401b1015295a42955cd8a0a6765dc088cfdbfb16ff971a3ff94b5262b40c2acf4ee879a4baa87b4abd43a99c71862218fb8885a54fb6eb19c23549386b56f2e6c62125c734d1a74d089f53b88144c484d2fab133fc5d7e029d03447af03ba33f61a66f2199b4a60851665da6609638c3c8b54acc0e1bc857590d11856974cc43e041c4fc348ebc3204973610b9cb47194a118dac41ec78415b75704baa168aa0388ed56f90625bc880c58b929fce59481018b7e46b4f0ae85a5fa6b03628984f00434058116c9b025967af178660bce6c90e8b54276ac95de58818f5c499a52a8e4cadfa5092d828181e977b3a859f7129626fb156bce3a43b039b274701fee0c085cca06b405e14f459b4f88c088bc1cfab3f5c1c4fae025737f853028a2f09b68d4a41886f31a708d16aa0016a502c71f2341aa314ac1e9059241cb6f9fb8dc10425f8f5466b7aac777813ae73a997d30d466100b3b268d165171a756658802f10570ef5008a2372b27cf1357b301843e2ad80fb2e87276d13eb9e9afc5489da7ab900cac367a6579ba6868c2092c1c59a5c6ba7a7481a5bc992cc492866671c8bbc9e851ac89a2c3b012cec709d8b170f0ac484185456a64b718eec818940336922376c30a3a136baeb685877471003cc4f6475778571b4a5c6073f0410523a3f6f5b80789320a15163c7dc0caa7c41a0389afc3018495842e78bb0b0c04b395ac0cbab3219d07c465b42a0a21e7d78c8c2314ab7c17c31c748f200a41912c034861aa57532213ca1a7f4933ba4235c4825937a12c7c46ef8cc9d2125948374c19bb196a72aa1b0ac1a2ba261fb4552aa17b3d562c335ca835e6a15ebb79c152546e6dcb8a935c596e440e26c9032399cd83c918d000187c343d7e61c052a483c3a2bc8337b221a3340844b14066ed38725b993a5fad2c9f6652e3bf5ce85b9c102538edd3617405734e39236d58526a9245c5242a34826c106447eb44652ec56b0874c35b502a2345b0f62631a900b53a379bd1eeb590bc9bb899aa45b6c44fe653f41a183e07c5af8056cac95819b03075cc37577bc28bc6c77a5464488888474aa0e373c0c66f5358e9b378e5a693ab75c1e977df1b1a3d5c5c7d977b5f6807c26e6104e92c4e2e33be154a9a019987736a2fd712fa281cbc2d881ac17355dc5a0bd6876a64c4b62025566c3cb46b27dcde5b672907d335c58041969dcac0ce6f292bda246f8d049161a53f45900fc85382c1cbdda140cf677ba6276bbb8601c38840450f099348b18fad6284a521f9577995779b07f58053af7414d64a8c411a4975b00d4f7c706d0a5ae2081b9364a480bc4c694b25ab09393ccaf93d069b6da88692c08b5724197244f8f865783b69d27188609f7b9a4c355a01aca61f393eaaa109237c440331f0888a6b70522b0273acf28a90c081dc07273f855a725b6ca53770869cb0dd83c5397d00fa7b711eb26848f17a1508113bc906c901160eabb785f6c95c22038622064d891265a831cca2539a6796f746c024c67bca85c89e63a3c9a3b08f0c970c8ca579015c290a2924f5c5046137c371697fdd100baeb3ba7d749e4d0bd3660584992a7cfa5a53f07b404411459f288151228c5d3153764b23d2485c9b34a12196a8624755b8c650ed9a995f4550d84a571a2cf9f35be34a686fa5c0b36d0b93f987c15c3050e15b78a7ab965d5a963c3636b87cd07139e26d41bed8a289023bc30f6c60b24b375151870552fc58a5eaca5ade9a0512493b75b93ceea9613e8e9c531605e590349bc21cce51a34c4d93234d2a04186900f79020eb56b64776740a004c07a2154b1a0dfc04a8691c21ce5ae62b0a155d5a16d69461662441c57b01665a060008946295bb694515df5ab59f0203c48107f72a083fbcd8890bee44b5890e34ed5196fc8101e2d3c7f6a5331151b00a71b6ba6e1aca3519de2804c41a10bfbf243e345986498a1859c7a7931c29116a4bd781939e2247c238289863072d3cb3d772b51e5bd527523d5a75d2f91bd07a21b38fb4baef65b03613a4acc0ce3678a81f79311a7a407f2bbd5b4361307adec486cb3d708e97b67a80651d5742d84f27d5c5486124573668b7d7bfc08e08064f4861c884c411bc5a47458356794cf985915bb30366d453ae5d108e6f7abac4a9bb397530989c049e542deb7694233cf87548141b2855b1064c677c8f33c4859a9a53ab27455937a3db67d522800f1533c26c45471d471b15907a7f7c93d8004da94a2280b05d8e96b03331b275068ab97358f368b8833b56ef660180060f9828386e9c00a69c99b7a743e74bd79f903e1317df9072adce4ada0b8af06166d75e926e5c4a4d9374245ec22bc27b411c3ba19431f7e244aaad65bfc42667d055da6d906781c2b73a0851b9b200a559cc4f3768fabca49f42858045ea60a995f9746d07a5cff19b5d31c10d204b141f214d78a7c372667fd85406a01538d10ab6d74176f81167a6a59ba41b1c8758ca0718abc9987c5c6186bc38c06943b85495bf65431c4d6847b9b58d50b4702f4c5527803ff5b6062846f356b4533190190a19828e23c5c007bf4187b5fa4bf5632c2d3299df35708a225288d8321a131a543544826c7a3a7b7ce57416d30c896d3d76dde21c5dfa1504798b8f1d6253751c36948c3bd1a10e515a99f813ae6aa5a0bb7bfa02b2926b1115e90c166bbb0ce5959b83508227c2fdf7c7cd0c2cdfe953de6b00d8b1a4ecc015d2e51b34f7758666592f08677fe03a770954b1788c0ce73c52e2c8623201dafd52167120a9f231e78166907e0770c2ab2a8f2cddd291790a6acaa65c2a0d469b8833d8a8817a2e46bf610a993655a95d14dc2d4669e5c7b1bf4b302cf45e205a5e2a8c94f339d54d55c99619b881fcf5dd0f7ade28f7ba71fe2ef2c9dae3079b83d20760766b17b7f7b5ab259480ae08fe2ad010697a5b83a5727",
        "dilithiumPrivateKey": "dde1423d73601ab7eb4dbc2ae2760137d47d3e89f6ba8f5da736ec499246903f0cc5aa801c05da903f4e62025f51c814630e4a0bd7e31e9cf259aa21b0f127971347d3758db28e58588eff7cfcad610ccf8b7d9d1a586178c56d7af932247296641ebebfc34a3da8c60811645d7daca6da6f095fa98d96112c50e24386203ab95cc86150100a12b28112a991203484dc023243c60980140954946c0025714ba28d02362613238214331019b41012142a422281d498852434805a1290d4c60003c80589261289002443367092884c90b4308c08680b3269e2a284c90226832008e246421c290a0143321b87859b364149328044c209ccc88413218c99200cc2442280c08513a26453c09194246441b24ddca0614a00225132110b412401c30112c82d528660888260511070e3201121b140640041431872d8a0312210015ba26cc3986520a76823372cc800616438040a2611d2800ce3408ce3004dd2224008408e04198012c66c62263208c72de1b4045bb810823812182548c296881313692384854b98882037910834908a226c61c2101b0965c8362c10212511c32c0c92081123105c3001a32688cc484858180002c640e0028922a72d428264d1124ad32608cb269100c29004c645944820c1805100b22903494c9ac864882241210922c038864ca030d4425043228498920d52a0210a412e23c328d0a6440a226c610645d000268c34498ba44818a86d8c806da1b08143829121052e1b9290ca22920b0825009221908870c4c07158a6881c374401927102c89009144612128e8ac62503b42112016840064091a41121390e423409538210d14461a43010003582d326689a0691212960148124e1044522a811a22820a116258ab0711b45094c866cd8164d8a362dc2125189a00063a631c000028300128a22460c3530d2266e50901189247293b0504c32519b481052964508231008c368d90028e334901c177208994c1037284190711c164080a640103880e0b681980892c10852932049e4322e1a223260c444cac4601492810001710c8768193964d2306e0c33314bb611d9282c8c340488c46c0811110c84406246229ac29084a2459206049b800092248ed32068e338528988505a942122212c8a4809a2008edab40d11c028840648da4671c2942402b7685b26680b3790830421a0b808e2b46ca4b621cc246213454c424621cb12019034640995299bb29104120962b6280485855ab201c9366999180ca230269b9d783233a70f2fe1b37fba7ebf40a81207bc2debb8f56d577680f8ac92436d403ec22100d92e39d5bfbbbcbaa5c875c75ecd4ea8db9aba59af4224cfe73f0538d69285bf74a6b5b301a0e58d9ed6029a95e3711bca278fb2f98ec10e85705f8bd526b8fd822c43cff3417ba681875b41ba793c518551b553563599b28102b6ce4b7e0232ce74a4beb1aabe2fa78d1762b561f6d6361069859e24281a9d772c12b0ada249461a00ee02321154fcf613207124d3e2532dd89d62b2cf7e0d75902575857b799e9a2fcf8d8be7795abfccf6876875818805945acd5d82d3c11b4a7efe1144754d0d4e37ae6db362dfaf4da325b6f891c0973ab8c4158d43791e80ea84b9a8e9b34663641d13bebdeb41495b48b84b4ee0f3bdd7ec137c504d5f4d78b15e1b1f405322b0a72524f714ced00708c2795aadc1aff1243774c1ff07e9d824826d962c06c27e02561d3d127163f979f09643ff84cc430014a5a3536dbdcc96d01dab58c0f7b6348704badf297ce3a07d78d8aee23b57861597b3d56f7279a78dae4f24abc8580c8c9d4b55ac866324c00653844849bc5181c73ed5c10b05ca7d1faa70dfa5fafec207513c368a76e9b1102924d1fefaaa7c13479fbf327bb49531c231e7d7ae09fdffbb075d866e38137733c4954d3315ce3f551850217869c44750927e5fdd11f541165967148623970b6bbc8118071afa8e604238422b27de3e2dee9b338e1d85ac7310b2b759ce89b4b5bc7e88f57d3e6603efb07d4ae1a1628431742bbdd6e28fe4e3d714a297af2492b650343c86332c2b39cc80a2ba97b1a0f864cbb3906541c1af2401ac5ac16f2ff636a15b707fefa9bce9a687bf067497f53b820fd5f4df87569e85359abd309a0a65faa0d4025e60c96894a244727091e112508de3d062e97ab5d09f259ee6b3d1ee57ed9e60689068142d0f33358364d89d799eb505fbfb244b8943dfe676f0b6f1248e7b0e2cf53df2777191bc992fd80079d4f05662116f4c8481c61d07c95f6cb59d7c12f9a6a76da24c6f3e8379db6002cc26211435a10b29e1c8ecf45a1d8a40f3c3a485b88141775d8743766e02f835b482730cf617d86fce68d3f7a3d3dd5e6ba7c14105264f2be62c8c4e980941a0f2b530cbbdfc1b71bfe243ff870a4dbbf962ecc23654eb2f9bb24262cac7f4a9203c5e052981674ac53f2c663643b52d415e26b566e5126a6f72d1797542b366e99c769a4436c982f7dc05498aac213b691aa30008cb61db4966178bb738b8c085fa73779bd3d25c03d9511476d56d112a515a6c7b945ccd8644f858fd754da5b23126e52084505dca287f760a7774f2bfeff6e398d075441f75d1fd98298fd7cefb388ad3a217951e1566e9bcfe60fe9c2544f825d9f938e43309f9eca12a62a83264d8f3970a2d895d81b3046398dba1969605d13cf9631da5c467c76cac77faf5954c7ef6dfcf56a876402b5ba66a35f79266ca19b294d28e35cbdedf8eb941f5482cec284c3af0d34ad546ff00df7bb7f2c291493d255ce2654c66978123d7143c236b1d4f879757efc1e9839c886fc668a09a823558a8494465e46286aa554dcecd079e4c2ce86b7797d37a9755a7a3b9d8ae92cf224b490218ce3cec51df8b3dec3459c0ff004664c12f5df4a4218a242d63f400cb223abfc1cecc85d160687595a2804b9a806065c38a0a890159c4dd147723ecc7998a6a7c9894b2f7da244b657cb6bf361bb290de99f5df6f67268043564e63dd7cd8abd739898f09f2c78a7fd5ebd28ee1b6584c338ec0e72b112f8e5290ccd4a3b598ac32c444b7f84d0ec65f05b63b25671249d62e0af29f47dbe2ce96b6aa9f86e97deb9b59bf550602e25395c35040dfd720b80ede8a23cfbf62b058909983039162e0ab03519d2d67b99847bae3702bf1340480ed1a153e1d03ab63c58a0597312fce8ec130f05fe6987552f48b75f5877cd92e19a7815176f807949def07176dc3bdfeb9f2d6d3006b5b52c02f7a7ed0a89f713870590be02c647206ff6e4f280edaa6815d49e4ee475f741cc75c76ca73fb5925dc9b093bf803f1f9482511056e33b6aa9eec9b35c11323371808ab10af80e51df07a244f80d1536438b2168223a5e6ef013bb93984ffea1237225bf670efc98774caf2753ab95cb4326f460a92f51253c25f332372e041dee67b6f4651a0259c27fa5bd58b86ab9cfea7c398f843427e61246de466733abc355affa5d1fd08c2e6d28335c9d07d13c03e5c3e40c9ebf76645152ec2215151dc4e97bcf6d9752e3780355a4da0f2ceb48feb27cf64e85c7bbf227296d100f467"
    }
};

// DOM Elements
const landingView = document.getElementById('landing');
const homeView = document.getElementById('home');
const userEmailSpan = document.getElementById('user-email');
const currentUrlP = document.getElementById('current-url');
const redirectBtn = document.getElementById('redirect-btn');
const generatePwdBtn = document.getElementById('generate-pwd');
// const viewSitesBtn = document.getElementById('view-sites');
const logoutBtn = document.getElementById('logout-btn');

// State management
let currentUser = null;
let currentTab = null;

// Initialize extension
async function init() {
    try {
        // Check if user is authenticated
        const identity = await chrome.cookies.get({
            url: 'http://34.55.135.135:5000/',
            name: 'digital_identity'
        }) || sample;
        console.log(identity);
        if (identity) {
            //currentUser = await fetchUserInfo(identity.value);
            showHomeView();
        } else {
            showLandingView();
        }

        // Get current tab
        const [tab] = await chrome.tabs.query({ active: true, currentWindow: true });
        currentTab = tab;
        if (currentTab && currentTab.url) {
            currentUrlP.textContent = new URL(currentTab.url).hostname;
        }
    } catch (error) {
        console.error('Initialization failed:', error);
        showLandingView();
    }
}

// View management
function showLandingView() {
    landingView.classList.remove('hidden');
    homeView.classList.add('hidden');
}

function showHomeView() {
    landingView.classList.add('hidden');
    homeView.classList.remove('hidden');
    if (currentUser && currentUser.email) {
        userEmailSpan.textContent = currentUser.email;
    }
}

// User information
async function fetchUserInfo(identityToken) {
    try {
        const response = await fetch(`${VM1_BASE_URL}/user`, {
            headers: {
                'Authorization': `Bearer ${identityToken}`
            }
        });
        
        if (!response.ok) throw new Error('Failed to fetch user info');
        return await response.json();
    } catch (error) {
        console.error('Error fetching user info:', error);
        return null;
    }
}

// Password generation and management
async function generatePassword() {
    try {
        if (!currentTab || !currentTab.url) {
            throw new Error('No active website');
        }

        const hostname = new URL(currentTab.url).hostname;
        
        // Get keypair from cookies
        const keypair = await chrome.cookies.get({
            url: VM1_BASE_URL,
            name: 'keypair'
        }) || sample.privateIdentity.kyberPrivateKey+sample.privateIdentity.dilithiumPrivateKey;

        if (!keypair) {
            throw new Error('No keypair found');
        }

        // Get password requirements from website
        const requirements = await detectPwReq(currentTab.id);

        // Request password from VM2
        const passwordResponse = await fetch(`${VM2_BASE_URL}/gen-password`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                keypair: keypair,
                requirements,
                website: hostname
            })
        });

        if (!passwordResponse.ok) {
            throw new Error('Failed to generate password');
        }

        const { password } = await passwordResponse.json();

        console.log(password);
        if (!currentTab || !currentTab.id) {
            throw new Error("No active tab detected");
        }
        // await chrome.tabs.sendMessage("bnnbmmjepappghgmahecdejkfdaehejd", {
        //     action: 'fillPassword',
        //     password
        // });

        const passwordField = document.querySelector('input[type="password"]' || 'input[name="password"]' || 'input[name="pass"]');
        if (passwordField) {
            passwordField.value = password;

            // Trigger input and change events to ensure the webpage detects the update
            passwordField.dispatchEvent(new Event('input', { bubbles: true }));
            passwordField.dispatchEvent(new Event('change', { bubbles: true }));
        } else {
            console.error("Password field not found!");
        }

        alert('Password generated and filled successfully');

        // If password is not injected, add it to the HTML
        const passwordContainer = document.getElementById('password');
        passwordContainer.classList.remove('hidden');
        passwordContainer.querySelector('p').textContent = password.substring(0, 12);
    } catch (error) {
        console.error('Password generation failed:', error);
        alert('Failed to generate password: ' + error.message);
    }
}

// Password requirements detection
async function detectPwReq(tabId) {
    try {
        // Inject content script to analyze password field
        const [requirements] = await chrome.scripting.executeScript({
            target: { tabId },
            function: () => {
                const passwordField = document.querySelector('input[type="password"]');
                if (!passwordField) return null;

                // Get requirements from aria attributes or other metadata
                const minLength = passwordField.getAttribute('minlength') || 8;
                const pattern = passwordField.pattern || null;
                const required = passwordField.required || false;

                return {
                    minLength: parseInt(minLength),
                    pattern,
                    required,
                    // Additional requirements that might be specified in page metadata
                    specialChars: document.querySelector('meta[name="password-special-chars"]')?.content === 'true',
                    numbers: document.querySelector('meta[name="password-numbers"]')?.content === 'true',
                    uppercase: document.querySelector('meta[name="password-uppercase"]')?.content === 'true'
                };
            }
        });

        return requirements?.result || {
            minLength: 12,  // Default requirements if none detected
            specialChars: true,
            numbers: true,
            uppercase: true
        };
    } catch (error) {
        console.error('Error detecting password requirements:', error);
        return null;
    }
}

// Utility functions
async function hashPassword(password) {
    const encoder = new TextEncoder();
    const data = encoder.encode(password);
    const hashBuffer = await crypto.subtle.digest('SHA-256', data);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
}

// Event listeners
redirectBtn.addEventListener('click', () => {
    chrome.tabs.create({ url: `${VM1_BASE_URL}/` });
});

generatePwdBtn.addEventListener('click', generatePassword);

// viewSitesBtn.addEventListener('click', () => {
//     chrome.tabs.create({ url: 'saved-sites.html' });
// });

logoutBtn.addEventListener('click', async () => {
    // Clear cookies
    await chrome.cookies.remove({
        url: VM1_BASE_URL,
        name: 'digital_identity'
    });
    await chrome.cookies.remove({
        url: VM1_BASE_URL,
        name: 'keypair'
    });
    
    // Reset state and show landing view
    currentUser = null;
    showLandingView();
});

// Initialize on load
document.addEventListener('DOMContentLoaded', init);
